# ğŸš€ æ‰¹é‡å¤„ç†ä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æ‰¹é‡å¤„ç†ç³»ç»Ÿå¯ä»¥è‡ªåŠ¨å¤„ç† `auxiliary/images/` ç›®å½•ä¸‹çš„æ‰€æœ‰å›¾åƒæ–‡ä»¶ï¼Œæ”¯æŒå®Œæ•´çš„ç›®æ ‡æ£€æµ‹åˆ°SAMç²¾ä¿®æµç¨‹ã€‚

### âœ¨ ä¸»è¦ç‰¹æ€§

- **ğŸ”„ è‡ªåŠ¨åŒ–æµç¨‹**ï¼šç½‘æ ¼ç”Ÿæˆ â†’ APIç›®æ ‡æ£€æµ‹ â†’ SAMç²¾ä¿® â†’ è¾“å‡ºæ¸…ç†
- **ğŸ¯ æ™ºèƒ½ç›®æ ‡æ˜ å°„**ï¼šå†…ç½®å¸¸è§å›¾åƒçš„ç›®æ ‡æ£€æµ‹æŸ¥è¯¢
- **âš¡ å¹¶è¡Œå¤„ç†**ï¼šæ”¯æŒå¤šçº¿ç¨‹å¹¶è¡ŒåŠ é€Ÿ
- **ğŸ›¡ï¸ é”™è¯¯é‡è¯•**ï¼šå¤±è´¥è‡ªåŠ¨é‡è¯•æœºåˆ¶
- **ğŸ“Š è¯¦ç»†æŠ¥å‘Š**ï¼šå¤„ç†ç»“æœç»Ÿè®¡å’Œé”™è¯¯åˆ†æ
- **ğŸ§¹ è¾“å‡ºæ¸…ç†**ï¼šåªä¿ç•™æœ€ç»ˆæ©ç å’Œinstanceä¿¡æ¯

## ğŸ—ï¸ è¾“å‡ºç»“æ„

### æ ‡å‡†æ¨¡å¼è¾“å‡º
```
outputs/clean_sculpt/[image_name]/
â”œâ”€â”€ final_mask.png          # æœ€ç»ˆåˆ†å‰²æ©ç 
â”œâ”€â”€ instance_info.txt       # å®ä¾‹ä¿¡æ¯æ–‡ä»¶
â”œâ”€â”€ final_visualization.png # å¯è§†åŒ–ç»“æœ
â””â”€â”€ round*_step*_*.png      # ä¸­é—´æ­¥éª¤æ–‡ä»¶
```

### æ¸…ç†æ¨¡å¼è¾“å‡º (`--clean-output`)
```
outputs/clean_sculpt/[image_name]/
â”œâ”€â”€ final_mask.png     # æœ€ç»ˆåˆ†å‰²æ©ç 
â””â”€â”€ instance_info.txt  # å®ä¾‹ä¿¡æ¯æ–‡ä»¶
```

### instance_info.txt å†…å®¹ç¤ºä¾‹
```
Sample: f
Instance: scorpionfish
Description: The scorpionfish is camouflaged against the sandy seabed...
Final mask pixels: 62645
ROI: (427.0, 320.0, 995.0, 639.0)
Processing rounds: 4
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡
```bash
# æ¿€æ´»ç¯å¢ƒå¹¶è®¾ç½®APIå¯†é’¥
conda activate camo-vlm
export DASHSCOPE_API_KEY="your_api_key_here"
```

### 2. åŸºæœ¬ä½¿ç”¨
```bash
# å¤„ç†æ‰€æœ‰å›¾åƒï¼ˆä½¿ç”¨APIæ¨¡å¼ï¼Œæ¸…ç†è¾“å‡ºï¼‰
python batch_process.py --use-api --clean-output

# å¤„ç†æŒ‡å®šå›¾åƒ
python batch_process.py --use-api --include f dog cat

# æ’é™¤æŸäº›å›¾åƒ
python batch_process.py --use-api --exclude person person2
```

### 3. å¹¶è¡Œå¤„ç†
```bash
# ä½¿ç”¨4ä¸ªå¹¶è¡Œè¿›ç¨‹
python batch_process.py --use-api --parallel 4 --clean-output
```

## ğŸ“‹ å®Œæ•´å‘½ä»¤å‚è€ƒ

### åŸºæœ¬å‚æ•°
```bash
--image-dir DIR           # å›¾åƒç›®å½• (é»˜è®¤: auxiliary/images)
--include NAME [NAME...]  # åªå¤„ç†æŒ‡å®šå›¾åƒ (ä¸å«æ‰©å±•å)
--exclude NAME [NAME...]  # æ’é™¤æŒ‡å®šå›¾åƒ (ä¸å«æ‰©å±•å)
--target "QUERY"         # ç»Ÿä¸€çš„ç›®æ ‡æ£€æµ‹æŸ¥è¯¢
```

### APIå‚æ•°
```bash
--api-key KEY           # APIå¯†é’¥ (æˆ–è®¾ç½®ç¯å¢ƒå˜é‡)
--api-model MODEL       # APIæ¨¡å‹ (é»˜è®¤: qwen-vl-plus-latest)
--use-api              # ä½¿ç”¨APIæ¨¡å¼
--use-openai-api       # ä½¿ç”¨OpenAIå…¼å®¹æ¨¡å¼
--high-resolution      # å¯ç”¨é«˜åˆ†è¾¨ç‡æ¨¡å¼
```

### å¤„ç†å‚æ•°
```bash
--grid-size SIZE       # ç½‘æ ¼å¤§å° (é»˜è®¤: 9)
--rounds NUM           # SAMç²¾ä¿®è½®æ•° (é»˜è®¤: 4)
--ratio FLOAT          # è±¡é™æ¯”ä¾‹ (é»˜è®¤: 0.8)
--vlm-max-side SIZE    # VLMè¾“å…¥æœ€å¤§è¾¹é•¿ (é»˜è®¤: 720)
--output-format FORMAT # è¾“å‡ºæ ¼å¼ png/jpg (é»˜è®¤: png)
--clean-output         # åªä¿ç•™æœ€ç»ˆæ©ç å’Œinstanceä¿¡æ¯
```

### æ‰¹å¤„ç†å‚æ•°
```bash
--parallel NUM         # å¹¶è¡Œå¤„ç†æ•° (é»˜è®¤: 1)
--retry-count NUM      # å¤±è´¥é‡è¯•æ¬¡æ•° (é»˜è®¤: 2)
--report-dir DIR       # æŠ¥å‘Šä¿å­˜ç›®å½• (é»˜è®¤: batch_reports)
```

### è·³è¿‡æ­¥éª¤é€‰é¡¹
```bash
--skip-grid           # è·³è¿‡ç½‘æ ¼ç”Ÿæˆ
--skip-detection      # è·³è¿‡ç›®æ ‡æ£€æµ‹  
--skip-build          # è·³è¿‡SAMè¾“å…¥ç”Ÿæˆ
--skip-sculpt         # è·³è¿‡SAMç²¾ä¿®
```

## ğŸ’¡ ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

### åœºæ™¯1ï¼šç”Ÿäº§ç¯å¢ƒæ‰¹é‡å¤„ç†
```bash
# æ¨èé…ç½®ï¼šAPIæ¨¡å¼ï¼Œæ¸…ç†è¾“å‡ºï¼Œå¹¶è¡Œå¤„ç†
python batch_process.py \
    --use-api \
    --clean-output \
    --parallel 3 \
    --api-model qwen-vl-plus-latest \
    --rounds 3 \
    --output-format png
```

### åœºæ™¯2ï¼šæµ‹è¯•å•ä¸ªå›¾åƒ
```bash
# å¤„ç†å•ä¸ªå›¾åƒï¼Œä¿ç•™æ‰€æœ‰ä¸­é—´æ–‡ä»¶ç”¨äºè°ƒè¯•
python batch_process.py \
    --use-api \
    --include f \
    --rounds 2 \
    --ratio 0.8
```

### åœºæ™¯3ï¼šå¤§æ‰¹é‡å¤„ç†
```bash
# é«˜å¹¶è¡Œï¼Œé«˜æ•ˆå¤„ç†ï¼Œæˆæœ¬ä¼˜åŒ–
python batch_process.py \
    --use-api \
    --clean-output \
    --parallel 5 \
    --api-model qwen-vl-plus-latest \
    --rounds 2 \
    --ratio 0.6 \
    --vlm-max-side 512
```

### åœºæ™¯4ï¼šè‡ªå®šä¹‰ç›®æ ‡æ£€æµ‹
```bash
# ä½¿ç”¨ç»Ÿä¸€çš„ç›®æ ‡æŸ¥è¯¢ï¼Œè¦†ç›–é»˜è®¤æ˜ å°„
python batch_process.py \
    --use-api \
    --target "find the hidden animal in the image" \
    --include cat dog person
```

### åœºæ™¯5ï¼šåˆ†æ­¥å¤„ç†
```bash
# åªæ‰§è¡Œç›®æ ‡æ£€æµ‹ï¼Œä¸åšSAMç²¾ä¿®
python batch_process.py \
    --use-api \
    --skip-sculpt

# åªæ‰§è¡ŒSAMç²¾ä¿® (å‡è®¾å·²æœ‰æ£€æµ‹ç»“æœ)
python batch_process.py \
    --use-api \
    --skip-grid \
    --skip-detection \
    --skip-build
```

## ğŸ“Š æŠ¥å‘Šå’Œç›‘æ§

### å®æ—¶è¿›åº¦
```
============================================================
ğŸš€ æ‰¹é‡å›¾åƒå¤„ç†ç³»ç»Ÿ
============================================================
APIå¯†é’¥: sk-a2047...
APIæ¨¡å‹: qwen-vl-plus-latest
å¾…å¤„ç†å›¾åƒ: 5
  - f
  - dog
  - cat
  - q
  - person2
å¤„ç†æ¨¡å¼: API
å¹¶è¡Œæ•°: 3
æ¸…ç†è¾“å‡º: æ˜¯

[1/5] å¤„ç† f...
============================================================
ğŸ–¼ï¸  å¤„ç†å›¾åƒ: f
   è·¯å¾„: auxiliary/images/f.png
============================================================
[10:45:23] ç”Ÿæˆç½‘æ ¼æ ‡æ³¨å›¾
[10:45:25] APIç›®æ ‡æ£€æµ‹
[10:45:28] ç”ŸæˆSAMè¾“å…¥
[10:45:30] SAMç²¾ä¿®
âœ… f å¤„ç†å®Œæˆ! ç”¨æ—¶: 45.2ç§’
```

### æ‰¹å¤„ç†æŠ¥å‘Š
ç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆä¸¤ç§æŠ¥å‘Šï¼š

#### 1. JSONè¯¦ç»†æŠ¥å‘Š (`batch_report_YYYYMMDD_HHMMSS.json`)
```json
{
  "timestamp": "2025-09-17T02:59:07",
  "summary": {
    "total_images": 5,
    "successful": 4,
    "failed": 1,
    "success_rate": 80.0,
    "total_processing_time": 234.5,
    "average_processing_time": 46.9
  },
  "results": [...]
}
```

#### 2. æ–‡æœ¬æ‘˜è¦æŠ¥å‘Š (`batch_summary_YYYYMMDD_HHMMSS.txt`)
```
============================================================
æ‰¹é‡å¤„ç†æŠ¥å‘Š
============================================================
å¤„ç†æ—¶é—´: 2025-09-17 10:59:07
æ€»å›¾åƒæ•°: 5
æˆåŠŸ: 4
å¤±è´¥: 1
æˆåŠŸç‡: 80.0%
æ€»å¤„ç†æ—¶é—´: 234.5ç§’
å¹³å‡å¤„ç†æ—¶é—´: 46.9ç§’/å›¾åƒ

æˆåŠŸå¤„ç†çš„å›¾åƒ:
----------------------------------------
âœ… f (45.2s)
   è¾“å‡ºæ–‡ä»¶: final_mask.png, instance_info.txt
âœ… dog (52.1s)
   è¾“å‡ºæ–‡ä»¶: final_mask.png, instance_info.txt
...

å¤±è´¥çš„å›¾åƒ:
----------------------------------------
âŒ person2: APIè°ƒç”¨å¤±è´¥: Connection timeout
```

## âš™ï¸ é»˜è®¤ç›®æ ‡æ˜ å°„

ç³»ç»Ÿå†…ç½®äº†å¸¸è§å›¾åƒçš„ç›®æ ‡æ£€æµ‹æŸ¥è¯¢ï¼š

```python
DEFAULT_TARGETS = {
    'f': 'find the camouflaged scorpionfish',
    'dog': 'find the camouflaged dog', 
    'cat': 'find the camouflaged cat',
    'q': 'find the camouflaged animal',
    'person': 'find the camouflaged person',
    'person2': 'find the camouflaged person'
}
```

å¦‚æœå›¾åƒåä¸åœ¨æ˜ å°„ä¸­ï¼Œä¼šä½¿ç”¨é€šç”¨æŸ¥è¯¢ï¼š`find the camouflaged object in {name}`

## ğŸ›¡ï¸ é”™è¯¯å¤„ç†å’Œé‡è¯•

### è‡ªåŠ¨é‡è¯•æœºåˆ¶
- APIè°ƒç”¨å¤±è´¥è‡ªåŠ¨é‡è¯• (é»˜è®¤2æ¬¡)
- ç½‘ç»œè¶…æ—¶è‡ªåŠ¨é‡è¯•
- ä¸´æ—¶é”™è¯¯è‡ªåŠ¨é‡è¯•

### å¸¸è§é”™è¯¯å¤„ç†
1. **APIå¯†é’¥é”™è¯¯**ï¼šæ£€æŸ¥ç¯å¢ƒå˜é‡è®¾ç½®
2. **ç½‘ç»œè¶…æ—¶**ï¼šå¢åŠ é‡è¯•æ¬¡æ•° `--retry-count 3`
3. **å†…å­˜ä¸è¶³**ï¼šé™ä½å¹¶è¡Œæ•° `--parallel 1`
4. **ç£ç›˜ç©ºé—´ä¸è¶³**ï¼šä½¿ç”¨ `--clean-output` æ¸…ç†ä¸­é—´æ–‡ä»¶

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. APIæˆæœ¬ä¼˜åŒ–
```bash
# ä½¿ç”¨plusæ¨¡å‹ï¼Œé™ä½å›¾åƒå°ºå¯¸ï¼Œå‡å°‘è½®æ•°
--api-model qwen-vl-plus-latest \
--vlm-max-side 512 \
--rounds 2
```

### 2. å¤„ç†é€Ÿåº¦ä¼˜åŒ–
```bash
# é€‚åº¦å¹¶è¡Œï¼Œè·³è¿‡ä¸å¿…è¦æ­¥éª¤
--parallel 3 \
--clean-output \
--skip-grid  # å¦‚æœå·²æœ‰ç½‘æ ¼æ–‡ä»¶
```

### 3. å­˜å‚¨ç©ºé—´ä¼˜åŒ–
```bash
# æ¸…ç†è¾“å‡ºï¼Œä½¿ç”¨jpgæ ¼å¼
--clean-output \
--output-format jpg
```

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜1: å›¾åƒæ–‡ä»¶æ‰¾ä¸åˆ°
```
[ERROR] åœ¨ auxiliary/images ä¸­æœªæ‰¾åˆ°æ”¯æŒçš„å›¾åƒæ–‡ä»¶
```
**è§£å†³æ–¹æ¡ˆ**ï¼šç¡®ä¿å›¾åƒæ–‡ä»¶åœ¨æ­£ç¡®ç›®å½•ï¼Œæ ¼å¼å—æ”¯æŒ

### é—®é¢˜2: APIè°ƒç”¨å¤±è´¥
```
[ERROR] APIè°ƒç”¨å¤±è´¥: Connection timeout
```
**è§£å†³æ–¹æ¡ˆ**ï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œå¢åŠ é‡è¯•æ¬¡æ•°ï¼Œæ£€æŸ¥APIå¯†é’¥

### é—®é¢˜3: å†…å­˜ä¸è¶³
```
CUDA out of memory
```
**è§£å†³æ–¹æ¡ˆ**ï¼šé™ä½å¹¶è¡Œæ•°ï¼Œå‡å°‘å›¾åƒå°ºå¯¸ï¼Œä½¿ç”¨CPUæ¨¡å¼

### é—®é¢˜4: æƒé™é”™è¯¯
```
Permission denied: outputs/clean_sculpt/
```
**è§£å†³æ–¹æ¡ˆ**ï¼šæ£€æŸ¥ç›®å½•æƒé™ï¼Œåˆ›å»ºè¾“å‡ºç›®å½•

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. **ç¯å¢ƒé…ç½®**ï¼šcondaç¯å¢ƒæ¿€æ´»ï¼ŒAPIå¯†é’¥è®¾ç½®
2. **æ–‡ä»¶è·¯å¾„**ï¼šå›¾åƒæ–‡ä»¶å­˜åœ¨ï¼Œè·¯å¾„æ­£ç¡®
3. **ç½‘ç»œè¿æ¥**ï¼šAPIæœåŠ¡å¯è®¿é—®
4. **ç³»ç»Ÿèµ„æº**ï¼šå†…å­˜å’Œç£ç›˜ç©ºé—´å……è¶³
5. **æ‰¹å¤„ç†æŠ¥å‘Š**ï¼šæŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯

---

**ğŸ‰ ç°åœ¨ä½ å¯ä»¥é«˜æ•ˆæ‰¹é‡å¤„ç†å›¾åƒäº†ï¼å¼€å§‹ä½“éªŒè‡ªåŠ¨åŒ–çš„åˆ†å‰²ç³»ç»Ÿå§ï¼**