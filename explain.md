  🎯 精细雕刻阶段整体逻辑

  阶段1：初始状态准备

  输入：边界框(BBox) + 原始图像
  ↓
  SAM初步分割 → 获得初始掩码(Mask₀)
  ↓
  计算掩码边界框(Tb)作为新的ROI

  阶段2：候选点智能采样

  基于Mask₀的边界：
  - 70%采样在边界带(band) - 用于边界精细化
  - 15%采样在内部(inside) - 验证正确区域
  - 15%采样在外部(outside) - 验证排除区域

  采样密度：基于边界长度自适应，而非ROI大小

  阶段3：多尺度上下文提取

  对每个候选点：
  ↓
  计算尺度：基于掩码实际尺寸(Tb.w, Tb.h)
  ↓
  提取patch：[0.05, 0.08, 0.12] × 掩码最小边
  ↓
  生成正方形patch：中心对齐候选点
  ↓
  轻量增强：水平翻转 + 亮度微调

  阶段4：VLM智能分析

  对每个patch：
  ↓
  VLM判断：该点是否在目标上？
  ↓
  输出置信度分数：[0.0, 1.0]
  ↓
  结构化结果：{score, reason}

  阶段5：控制点精选

  基于VLM分数：
  ↓
  自适应阈值：根据分数分布动态确定
  ↓
  空间NMS：去除冗余点，确保均匀分布
  ↓
  分层选择：高置信度内部点 + 低置信度外部点
  ↓
  生成控制点：(x,y,label) 其中label=1(正)/0(负)

  阶段6：SAM精细雕刻

  输入：初始掩码 + 控制点
  ↓
  SAM迭代优化：
    - 每轮更新掩码
    - 计算IoU变化
    - 早停判断(变化<0.5%)
  ↓
  输出最终精细掩码(Mask_final)

  🔄 关键改进点

  从ROI驱动 → 掩码驱动

  - 尺度计算：从ROI尺寸改为掩码bbox尺寸
  - 采样策略：从三层均衡改为边界重点
  - patch大小：从[0.25,0.5,1.0]改为[0.05,0.08,0.12]更小尺度

  从全局修正 → 边界微调

  - 候选点分布：70%集中在边界带
  - 控制点作用：验证+微调，而非重构
  - 收敛更快：通常2-3轮即可收敛

  这个流程体现了**"SAM先粗分，VLM后精雕"**的核心思想，每个阶段都针对边界精细化做了专门优化。